<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Retrouvez vos articles préféré, fabriquer avec soins par nos main, venez jeter un coup d'oeil !">
    <title>Le magasin main | Orinoco</title>
    <link rel="stylesheet" href="./.public/css/style.css">
</head>
<body>
    <header>
        <img src="./images/logo.png" alt="Logo d'Orinoco représentant un caddie">
    </header>

    <section role="main" class="main main__checkout">
        <button id="back">retour</button>
        <h1 class="title">Panier</h1>
        <div>
            <h2>Produits : </h2>
            <ul id="ul">

            </ul>
            <button id="deleteCart">Vider le panier</button>
            <h2>Prix total :</h2>
            <p><span id="total__price"></span> €</p>
            <h2>Informations :</h2>
            <form onsubmit="validationForm()">
                <div class="formOrder">
                  <label for="firstName">Prénom :</label>
                  <input class="inputCustom" type="text" name="firstName" id="firstName" required>
                </div>
                <div class="formOrder">
                  <label for="lastName">Nom :</label>
                  <input class="inputCustom" type="text" name="lastName" id="lastName" required>
                </div>
                <div class="formOrder">
                    <label for="email">E-mail :</label>
                    <input class="inputCustom" type="email" name="email" id="email" required>
                  </div>
                  <div class="formOrder">
                    <label for="address">Adresse :</label>
                    <input class="inputCustom" type="text" name="address" id="address" required>
                  </div>
                  <div class="formOrder">
                    <label for="city">Ville :</label>
                    <input class="inputCustom" type="text" name="city" id="city" required>
                  </div>
                <div class="formOrder">
                  <input class="callToAction" type="submit" value="Valider">
                </div>
              </form>
    
            
        </div>
    </section>
</body>
<script>
// CHEKC IF CART IS EMPTY
let back = document.getElementById('back');
back.addEventListener("click", function (e) {
    window.location.href = "http://localhost/JWDP5/";
});

if ( localStorage.length == 0 ) {
    let deleteCart = document.getElementById('deleteCart');
    deleteCart.style.display = "none";

    let ul = document.getElementById('ul');

    let li = document.createElement('li');
    li.innerHTML = `<p>Vous n'avez pas de produit dans le panier</p>`;
    ul.appendChild(li);
}

let delete_cart = document.getElementById('deleteCart');
delete_cart.addEventListener('click', function() {
    window.localStorage.clear();
    window.location.href = "http://localhost/JWDP5/checkout";
})
function escapeHtml(text) {
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  
  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

    let ul = document.getElementById('ul');

    let total = 0;
    for (var i = 0; i < localStorage.length; i++){
        let id = JSON.parse(localStorage.getItem(localStorage.key(i))).id;
        let name = JSON.parse(localStorage.getItem(localStorage.key(i))).name;
        let price = JSON.parse(localStorage.getItem(localStorage.key(i))).price;
        let nb = JSON.parse(localStorage.getItem(localStorage.key(i))).nb;
        let li = document.createElement('li');

        li.innerHTML = 
            `
                <p>Nom : ${name} x ${nb}  =  ${price} €</p>
            `;
        ul.append(li);
        total = total + (price * nb);
    }
    let totalPrice = document.getElementById('total__price');
    totalPrice.textContent = total;


function checkEmail(email) {
    let regex = /^((?!\.)[\w-_.]*[^.])(@\w+)(\.\w+(\.\w+)?[^.\W])$/gim;
    let found = email.match(regex);
    if(found != null) {
        return email;
    } else {
        return null;
    }
}

// Regex First / last name [a-zA-Z_]*

function validationForm(){
    let inputs = document.getElementsByClassName('formOrder');
    let error = false;
    let contact = new Object();
    let products = new Array();


    for (var i = 0; i < inputs.length; i++) {
        let input = inputs[i].getElementsByTagName('input')[0];
        value = escapeHtml(input.value);
        if (input.type == "text") {
            contact[input.name] = value;
        }
        if (input.type == "email") {
            let result = checkEmail(value);
            if(result == null) {
                error = true;
            } else {
                contact[input.name] = value;
            }
        }
    }

    if(error == false) {
        for (var i = 0; i < localStorage.length; i++){
            let id = JSON.parse(localStorage.getItem(localStorage.key(i))).id;
            products.push(id);
        }

        var jsonBody = {contact,products};
        jsonBody = JSON.stringify(jsonBody);

        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (this.readyState == XMLHttpRequest.DONE && this.status == 201) {
                var response = JSON.parse(this.responseText);
                window.localStorage.clear();
                window.location.href = "http://localhost/JWDP5/payment_confirmation?id_order=" + response.orderId;
                
            } else {
                alert('Une erreure est survenue')
            }
        };

        let url = "http://localhost:3000/api/teddies/order";
        request.open("POST", url);
        request.setRequestHeader("Content-Type", "application/json");
        request.send(jsonBody);

    } else {
        alert('Une erreure est survenue dans le formulaire');
    }
}

</script>
</html>